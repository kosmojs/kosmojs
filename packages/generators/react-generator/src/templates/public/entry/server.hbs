import { renderToString } from "react-dom/server";
import { createStaticHandler } from "react-router";

import Router, { routeStack } from "../router";
import { baseurl } from "../config";

export default {
  async factory(url) {
    const handler = createStaticHandler(routeStack, { basename: baseurl });
    const context = await handler.query(new Request(`http://localhost${url}`));

    return {
      renderToString({ criticalCss }) {
        const head = criticalCss
          .map(({ text }) => `<style>${text}</style>`)
          .join("");

        const html = renderToString(Router({ context } as never));

        return { head, html };
      },
    };
  },
} satisfies import("@kosmojs/dev").SSRSetup;
